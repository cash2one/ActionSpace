{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <link href="{% static 'om/css/bootstrap.min14ed.css' %}" rel="stylesheet">
    <script src="{% static 'om/js/echarts.min.js' %}"></script>
	<script src="{% static 'om/js/dark.js' %}"></script>
    <script src="{% static 'om/js/jquery.min.js' %}"></script>
    <script src="{% static 'om/layer/layer.js' %}"></script>
    <script type="text/javascript" src="http://hq.sinajs.cn/list=sh000001" charset="gb2312"></script>
	<style type="text/css">
        html
        {
         height:100%;
         margin:0;
        }
        body
        {
            height:100%;
            margin:0; 
        }
    </style>
</head>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width:100%; height:100%"></div>
    <!--suppress JSUnresolvedVariable -->
    <script type="text/javascript">
        var legend_selected = {'指数': false, '竞猜': false};
        var flag = hq_str_sh000001.split(",")[3];
        {% if i_need_voted %}
            layer.prompt(
                {title: '请投票（当前参考指数：'+flag+'）！'},
                function(val, index){
                    if (!isNaN(val)) {
                        $.post("{% url 'utils:activity_vote' %}", {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'guess': val
                        },function(_) {
                            location.reload();
                        });
                    }
                    else {
                        location.reload();
                    }
                    layer.close(index);
                }
            );
        {% elif finished %}
            var chart_result = echarts.init(document.getElementById('main'), 'dark');
            chart_result.on('legendselectchanged', function (params) {
                legend_selected = params.selected;
            });
            function set_result_chart(name_arr, guess_arr) {
                if (name_arr.length != guess_arr.length) {
                    console.log('长度不一致');
                }

                var offset = [];
                var flags = [];
                guess_arr.forEach(function(e){
                    offset.push(Math.round((e-flag)*100)/100);
                    flags.push(flag);
                });

                var option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { // 坐标轴指示器，坐标轴触发有效
                            type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    toolbox: {
                        feature: {
                            restore: {},
                            saveAsImage: {}
                        }
                    },
                    legend: {
                        data: ['偏差', '指数', '竞猜'],
                        selected : legend_selected
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [{
                        type: 'value'
                    }],
                    yAxis: [{
                        type: 'category',
                        axisTick: {
                            show: false
                        },
                        data: name_arr
                    }],
                    series: [{
                        name: '偏差',
                        type: 'bar',
                        label: {
                            normal: {
                                show: true,
                                position: 'inside'
                            }
                        },
                        data: offset
                    }, {
                        name: '竞猜',
                        type: 'bar',
                        stack: '总量',
                        label: {
                            normal: {
                                show: true
                            }
                        },
                        data: guess_arr
                    }, {
                        name: '指数',
                        type: 'bar',
                        stack: '总量',
                        label: {
                            normal: {
                                show: true,
                                position: 'left'
                            }
                        },
                        data: flags
                    }]
                };

                chart_result.setOption(option);
            }
            function refresh_result_chart() {
                chart_result.showLoading();
                $.get("{%url 'utils:activity_data'%}", function(ele) {
                    set_result_chart(ele.names, ele.guess);
                });
                chart_result.hideLoading();
            }
            refresh_result_chart();
            chart_result.on('dblclick', function (_) {
                refresh_result_chart();
            });
            //setInterval(refresh_chart, 5000);
        {% else %}
            var chart_progress = echarts.init(document.getElementById('main'), 'dark');
            function set_progress_chart(joined_count, voted_count) {
                var option = {
                    tooltip: {
                        formatter: "{a} <br/>{b} : {c}%"
                    },
                    toolbox: {
                        feature: {
                            restore: {},
                            saveAsImage: {}
                        }
                    },
                    series: [
                        {
                            name: '完成率(双击指针可刷新数据)',
                            type: 'gauge',
                            // splitNumber: joined_count,
                            axisLine: {            // 坐标轴线
                                lineStyle: {       // 属性lineStyle控制线条样式
                                    color: [[0.09, 'lime'], [0.82, '#1e90ff'], [1, '#ff4500']],
                                    width: 3,
                                    shadowColor: '#fff', //默认透明
                                    shadowBlur: 10
                                }
                            },
                            axisLabel: {            // 坐标轴小标记
                                textStyle: {       // 属性lineStyle控制线条样式
                                    fontWeight: 'bolder',
                                    color: '#fff',
                                    shadowColor: '#fff', //默认透明
                                    shadowBlur: 10
                                }
                            },
                            axisTick: {            // 坐标轴小标记
                                length: 15,        // 属性length控制线长
                                lineStyle: {       // 属性lineStyle控制线条样式
                                    color: 'auto',
                                    shadowColor: '#fff', //默认透明
                                    shadowBlur: 10
                                }
                            },
                            splitLine: {           // 分隔线
                                length: 25,         // 属性length控制线长
                                lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                                    width: 3,
                                    color: '#fff',
                                    shadowColor: '#fff', //默认透明
                                    shadowBlur: 10
                                }
                            },
                            pointer: {           // 分隔线
                                shadowColor: '#fff', //默认透明
                                shadowBlur: 5
                            },
                            title: {
                                textStyle: {       // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                                    fontWeight: 'bolder',
                                    fontSize: 20,
                                    fontStyle: 'italic',
                                    color: '#fff',
                                    shadowColor: '#fff', //默认透明
                                    shadowBlur: 10
                                }
                            },
                            detail: {
                                backgroundColor: 'rgba(30,144,255,0.8)',
                                borderWidth: 1,
                                borderColor: '#fff',
                                shadowColor: '#fff', //默认透明
                                shadowBlur: 5,
                                //offsetCenter: [0, '50%'],       // x, y，单位px
                                textStyle: {       // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                                    fontWeight: 'bolder',
                                    color: '#fff'
                                },
                                formatter: '{value}%'
                            },
                            data: [{
                                value: Math.round(voted_count / joined_count * 100),
                                name: '投票中('+voted_count+'/'+joined_count+')'
                            }]
                        }
                    ]
                };
                chart_progress.setOption(option);
            }
            function refresh_progress_chart() {
                chart_progress.showLoading();
                $.get("{%url 'utils:activity_status'%}", function(result) {
                    if (result.voted_count < result.joined_count) {
                        set_progress_chart(result.joined_count, result.voted_count);
                    }
                    else {
                        location.reload();
                    }
                });
                chart_progress.hideLoading();
            }
            refresh_progress_chart();
            chart_progress.on('dblclick', function (_) {
                refresh_progress_chart();
            });
        {% endif %}
    </script>
</body>
</html>